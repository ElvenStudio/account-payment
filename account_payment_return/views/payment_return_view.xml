<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>
        <record model="ir.ui.view" id="payment_return_form_view">
            <field name="name">payment.return.form</field>
            <field name="model">payment.return</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
                <form string="Payment return">
                    <header>
                        <button name="action_confirm" string="Confirm" type="object" states="draft,imported" class="oe_highlight" />
                        <button name="button_match" string="Match" type="object" states="draft,imported" class="oe_highlight" />
                        <button name="action_cancel" string="Cancel" type="object" states="done" />
                        <button name="action_draft" string="Draft" type="object" states="cancelled" />
                        <field name="state" widget="statusbar" statusbar_visible="draft,done" />
                    </header>
                    <sheet string="Payment return">
                        <div class="oe_title">
                            <label for="name" class="oe_edit_only"/>
                            <h1><field name="name"/></h1>
                        </div>
                        <div class="oe_right oe_button_box">
                            <button string="Show Return"
                                    name="action_show_return_move"
                                    type="object"
                                    icon="fa-bars"
                                    widget="statinfo"
                                    class="oe_inline oe_stat_button oe_right"
                                    attrs="{'invisible':[('state','!=','done')]}" />
                        </div>
                        <group>
                            <group>
                                <field name="journal_id" domain="[('type', 'in', ['bank', 'cash'])]"/>
                                <field name="account_id" />
                                <field name="reconcile_mode" />
                                <field name="customer_debit_account_id"
                                       attrs="{
                                           'invisible':[('reconcile_mode', '=', 'auto-reconcile')],
                                           'required':[('reconcile_mode', '=', 'manual-return')]
                                       }"
                                       domain="[('type', '=', 'receivable')]" />
                                <field name="move_id" invisible="1" />
                            </group>
                            <group>
                                <field name="date"/>
                                <field name="period_id"/>
                                <field name="company_id" groups="base.group_multi_company"/>
                            </group>
                        </group>
	                    <notebook colspan="4">
	                        <page string="Lines">
	                            <field name="line_ids" colspan="4" nolabel="1" widget="one2many_list" context="{'return_id': id,'default_date': date, 'journal_id': journal_id}">
	                                <tree string="Payment return lines" editable="top">
	                                    <field name="return_reconcile_mode" invisible="1" />
	                                    <field name="date" />
	                                    <field name="concept" />
	                                    <field name="reason" />
	                                    <field name="partner_name" invisible="1"/>
	                                    <field name="partner_id" />
	                                    <field name="reference" />
	                                    <field name="move_line_ids"
                                               widget="many2many_tags" options="{'no_create': True}"
                                               domain="[
                                                   ('journal_id', '=', context.get('journal_id', False)),
                                                   ('partner_id', '=', partner_id),
                                                   ('account_id.type', '=', 'receivable'),
                                                   ('credit', '>', 0.0),
                                                   ('reconcile_ref', '!=', False)
                                               ]"
                                               attrs="{
                                                   'required':[('return_reconcile_mode', '=', 'auto-reconcile')],
                                                   'readonly':[('return_reconcile_mode', '=', 'manual-return')]
                                               }" />
	                                    <field name="amount" sum="total_amount" />
	                                </tree>
	                            </field>
	                        </page>
	                    </notebook>
                    </sheet>
                    <div class="oe_chatter">
	                    <field name="message_follower_ids" widget="mail_followers"/>
	                    <field name="message_ids" widget="mail_thread"/>
	                </div>
                </form>
            </field>
        </record>

        <record model="ir.ui.view" id="payment_return_tree_view">
            <field name="name">payment.return.tree</field>
            <field name="model">payment.return</field>
            <field name="type">tree</field>
            <field name="arch" type="xml">
                <tree string="Customer Payment Returns">
                    <field name="name"/>
                    <field name="date"/>
                    <field name="journal_id"/>
                    <field name="company_id" groups="base.group_multi_company"/>
                    <field name="state"/>
                </tree>
            </field>
        </record>

        <record id="payment_return_search_view" model="ir.ui.view">
            <field name="name">payment.return.search.view</field>
            <field name="model">payment.return</field>
            <field name="type">search</field>
            <field name="arch" type="xml">
                <search string="Search Payment Returns">
                    <field name="name" />
                    <field name="journal_id" />
                    <field name="date"/>
                    <field name="period_id"/>

                    <field name="name" string="Partner" filter_domain="[('line_ids.partner_id','ilike',self)]" />
                    <field name="name" string="Reference" filter_domain="[('line_ids.reference','ilike',self)]" />
                    <field name="name" string="Returned Payment" filter_domain="['|', ('line_ids.move_line_ids.name','ilike',self), ('line_ids.move_line_ids.ref','ilike',self)]" />

                    <filter string="Draft" domain="[('state','=','draft')]" help="Draft Returns"/>
                    <filter string="Done" domain="[('state','=','done')]" help="Posted Returns"/>
                    <separator />

                    <group expand="0" string="Reconcile mode">
                        <filter string="Automatic" domain="[('reconcile_mode','=','auto-reconcile')]" help="Automatically reconciled"/>
                        <filter string="Manual" domain="[('reconcile_mode','=','manual-return')]" help="Manual returns"/>
                        <separator />
                    </group>

                    <group expand="0" string="Group By">
                        <filter string="Journal" context="{'group_by':'journal_id'}"/>
                        <filter string="Period" context="{'group_by':'period_id'}"/>
                        <filter string="Status" context="{'group_by':'state'}"/>
                    </group>
                </search>
            </field>
        </record>


        <record model="ir.actions.act_window" id="payment_return_action">
            <field name="name">Customer Payment Returns</field>
            <field name="res_model">payment.return</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
        </record>

        <menuitem id="payment_return_menu"
                  name="Customer Payment Returns"
                  parent="account.menu_finance_receivables"
                  action="payment_return_action"
                  sequence="20"/>
    </data>
</openerp>
